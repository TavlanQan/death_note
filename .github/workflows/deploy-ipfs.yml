name: ðŸš€ Deploy to IPFS via Filebase

on:
  push:
    branches: ["main"]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ‡ÐµÑ€ÐµÐ· GitHub UI

env:
  FILEBASE_BUCKET: "dxn-front"
  FILEBASE_ENDPOINT: "https://s3.filebase.com"

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    # Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Node.js
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    # Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
    - name: ðŸ“¦ Install dependencies
      run: |
        npm ci
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ jq Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ JSON
        sudo apt-get update && sudo apt-get install -y jq
    
    # Ð¨Ð°Ð³ 4: Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
    - name: ðŸ—ï¸ Build project
      run: npm run build
    
    # Ð¨Ð°Ð³ 5: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ
    - name: ðŸ” Verify build
      run: |
        echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸ out:"
        ls -la out/
        echo "ðŸ“Š Ð Ð°Ð·Ð¼ÐµÑ€ Ð¿Ð°Ð¿ÐºÐ¸:"
        du -sh out/
    
    # Ð¨Ð°Ð³ 6: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ AWS CLI (Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ S3 API Filebase)
    - name: ðŸ”§ Install AWS CLI
      run: |
        echo "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ AWS CLI..."
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip -q awscliv2.zip
        sudo ./aws/install --update
        echo "âœ… AWS CLI ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½:"
        aws --version
    
    # Ð¨Ð°Ð³ 7: ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ AWS CLI Ð´Ð»Ñ Filebase
    - name: ðŸ” Configure AWS CLI for Filebase
      run: |
        echo "ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÑŽ AWS CLI Ð´Ð»Ñ Filebase..."
        aws configure set aws_access_key_id ${{ secrets.FILEBASE_ACCESS_KEY }}
        aws configure set aws_secret_access_key ${{ secrets.FILEBASE_SECRET_KEY }}
        aws configure set default.region us-east-1
        aws configure set default.s3.max_concurrent_requests 5
        aws configure set default.s3.max_queue_size 1000
        aws configure set default.s3.multipart_threshold 64MB
        aws configure set default.s3.multipart_chunksize 16MB
        aws configure set default.s3.use_accelerate_endpoint false
        aws configure set default.s3.addressing_style virtual
        echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
    
    # Ð¨Ð°Ð³ 8: Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð¼Ñ Ð´Ð»Ñ Ð¿Ð°Ð¿ÐºÐ¸ ÑÐ±Ð¾Ñ€ÐºÐ¸
    - name: ðŸ·ï¸ Generate unique folder name
      id: folder-name
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        COMMIT_HASH=$(git rev-parse --short HEAD)
        FOLDER_NAME="build-${TIMESTAMP}-${COMMIT_HASH}"
        echo "ðŸ“ Ð˜Ð¼Ñ Ð¿Ð°Ð¿ÐºÐ¸: ${FOLDER_NAME}"
        echo "FOLDER_NAME=${FOLDER_NAME}" >> $GITHUB_ENV
        echo "folder=${FOLDER_NAME}" >> $GITHUB_OUTPUT
    
    # Ð¨Ð°Ð³ 9: Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ out Ð² Filebase Ñ‡ÐµÑ€ÐµÐ· S3
    - name: ðŸ“¤ Upload to Filebase S3
      id: upload
      run: |
        echo "ðŸ”„ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð² Filebase S3..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿ÑƒÑ‚ÑŒ Ð² S3
        S3_PATH="s3://${{ env.FILEBASE_BUCKET }}/${{ env.FOLDER_NAME }}/"
        echo "ðŸ“¤ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽ Ð²: $S3_PATH"
        echo "ðŸŒ Endpoint: ${{ env.FILEBASE_ENDPOINT }}"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ S3
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ð±Ð°ÐºÐµÑ‚Ð°..."
        aws s3 ls "s3://${{ env.FILEBASE_BUCKET }}" --endpoint-url "${{ env.FILEBASE_ENDPOINT }}" || echo "Ð‘Ð°ÐºÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
        
        # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ out Ñ Filebase (Ñ€ÐµÐºÑƒÑ€ÑÐ¸Ð²Ð½Ð¾ ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹)
        echo "ðŸ“‚ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸ÑŽ..."
        aws s3 sync ./out/ "$S3_PATH" \
          --endpoint-url "${{ env.FILEBASE_ENDPOINT }}" \
          --acl public-read \
          --no-progress
        
        echo "âœ… Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
        echo "ðŸ“ Ð¤Ð°Ð¹Ð»Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð²: $S3_PATH"
        
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ
        echo "S3_PATH=$S3_PATH" >> $GITHUB_ENV
    
    # Ð¨Ð°Ð³ 10: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ CID Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· Filebase API
    - name: ðŸ†” Get CID from Filebase API
      id: get-cid
      run: |
        echo "ðŸ” ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÑŽ CID Ñ‡ÐµÑ€ÐµÐ· Filebase API..."
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
        echo "ðŸ” ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÑŽ Ñ‚Ð¾ÐºÐµÐ½ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸..."
        AUTH_RESPONSE=$(curl -s -X POST https://api.filebase.io/v1/account/auth \
          -u "${{ secrets.FILEBASE_ACCESS_KEY }}:${{ secrets.FILEBASE_SECRET_KEY }}")
        
        echo "ðŸ“„ ÐžÑ‚Ð²ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸:"
        echo "$AUTH_RESPONSE" | jq '.'
        
        TOKEN=$(echo "$AUTH_RESPONSE" | jq -r '.token')
        
        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾ÐºÐµÐ½"
          exit 1
        fi
        
        echo "âœ… Ð¢Ð¾ÐºÐµÐ½ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½"
        
        # Ð–Ð´ÐµÐ¼ 10 ÑÐµÐºÑƒÐ½Ð´, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Filebase Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» Ñ„Ð°Ð¹Ð»Ñ‹
        echo "â³ Ð–Ð´Ñƒ 10 ÑÐµÐºÑƒÐ½Ð´ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
        sleep 10
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð² Ð² Ð±Ð°ÐºÐµÑ‚Ðµ Ñ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ¾Ð¼ Ð½Ð°ÑˆÐµÐ¹ Ð¿Ð°Ð¿ÐºÐ¸
        FOLDER_NAME="${{ env.FOLDER_NAME }}"
        echo "ðŸ”Ž Ð˜Ñ‰Ñƒ Ð¿Ð°Ð¿ÐºÑƒ: $FOLDER_NAME"
        
        LIST_URL="https://api.filebase.io/v1/ipfs/buckets/${{ env.FILEBASE_BUCKET }}/keys?prefix=${FOLDER_NAME}/"
        echo "ðŸ“¡ Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÑŽ: $LIST_URL"
        
        LIST_RESPONSE=$(curl -s -X GET "$LIST_URL" \
          -H "Authorization: Bearer $TOKEN")
        
        echo "ðŸ“„ ÐžÑ‚Ð²ÐµÑ‚ Ð¾Ñ‚ Filebase API:"
        echo "$LIST_RESPONSE" | jq '. | {object_count: .objects | length}' 2>/dev/null || echo "$LIST_RESPONSE"
        
        # Ð˜Ñ‰ÐµÐ¼ CID Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ðµ
        CID=$(echo "$LIST_RESPONSE" | jq -r '.objects[0].cid // empty' 2>/dev/null)
        
        if [ -z "$CID" ]; then
          echo "âš ï¸ CID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ, Ð¿Ñ€Ð¾Ð±ÑƒÑŽ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹..."
          
          # ÐœÐµÑ‚Ð¾Ð´ 2: Ð˜Ñ‰ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· Ñ€ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ð¾Ðµ Ð²Ñ‹Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
          CID=$(echo "$LIST_RESPONSE" | grep -o 'Qm[1-9A-HJ-NP-Za-km-z]\{44,\}' | head -1)
        fi
        
        if [ -z "$CID" ]; then
          echo "âš ï¸ Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ð½Ðµ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°Ð», Ð¿Ñ€Ð¾Ð±ÑƒÑŽ Ñ‚Ñ€ÐµÑ‚Ð¸Ð¹ Ð¼ÐµÑ‚Ð¾Ð´..."
          
          # ÐœÐµÑ‚Ð¾Ð´ 3: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð¸Ð· Ð¿Ð°Ð¿ÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· S3 Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐµÐ³Ð¾ CID
          FIRST_FILE=$(aws s3 ls "s3://${{ env.FILEBASE_BUCKET }}/$FOLDER_NAME/" --endpoint-url "${{ env.FILEBASE_ENDPOINT }}" | head -1 | awk '{print $4}')
          
          if [ ! -z "$FIRST_FILE" ]; then
            echo "ðŸ“„ ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð² Ð¿Ð°Ð¿ÐºÐµ: $FIRST_FILE"
            
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ CID Ñ„Ð°Ð¹Ð»Ð°
            FILE_CID_RESPONSE=$(curl -s -X GET \
              "https://api.filebase.io/v1/ipfs/buckets/${{ env.FILEBASE_BUCKET }}/keys/${FOLDER_NAME}/${FIRST_FILE}" \
              -H "Authorization: Bearer $TOKEN")
            
            echo "ðŸ“„ ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð°:"
            echo "$FILE_CID_RESPONSE" | jq '.' 2>/dev/null || echo "$FILE_CID_RESPONSE"
            
            CID=$(echo "$FILE_CID_RESPONSE" | jq -r '.cid // .pinned.pin.cid // empty' 2>/dev/null)
          fi
        fi
        
        if [ -z "$CID" ]; then
          echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ CID Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"
          echo "ðŸ“ Ð’Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ Ð² Filebase Ð¸ ÑÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ CID Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ:"
          echo "   1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ https://console.filebase.com"
          echo "   2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ð±Ð°ÐºÐµÑ‚ '${{ env.FILEBASE_BUCKET }}'"
          echo "   3. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð¿Ð°Ð¿ÐºÑƒ '$FOLDER_NAME'"
          echo "   4. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° Ð¿Ð°Ð¿ÐºÑƒ â†’ Copy CID"
          echo "   5. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ IPNS Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ"
          
          # Ð’Ñ‹Ñ…Ð¾Ð´Ð¸Ð¼ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹, Ð½Ð¾ Ð½Ðµ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°ÐµÐ¼ workflow Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ
          echo "CID_NOT_FOUND=true" >> $GITHUB_ENV
          echo "cid=none" >> $GITHUB_OUTPUT
        else
          echo "ðŸŽ¯ Ð£Ð¡ÐŸÐ•Ð¥! ÐÐ°Ð¹Ð´ÐµÐ½ CID: $CID"
          echo "cid=$CID" >> $GITHUB_OUTPUT
          echo "IPFS_CID=$CID" >> $GITHUB_ENV
        fi
    
    # Ð¨Ð°Ð³ 11: ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ IPNS Ð·Ð°Ð¿Ð¸ÑÑŒ (ÐµÑÐ»Ð¸ CID Ð½Ð°Ð¹Ð´ÐµÐ½)
    - name: ðŸ”— Update IPNS record
      if: env.IPFS_CID != ''
      run: |
        echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÑŽ IPNS Ð·Ð°Ð¿Ð¸ÑÑŒ..."
        
        CID="${{ env.IPFS_CID }}"
        IPNS_KEY_NAME="${{ secrets.IPFS_KEY_NAME }}"
        
        echo "ðŸ”‘ IPNS ÐºÐ»ÑŽÑ‡: $IPNS_KEY_NAME"
        echo "ðŸ“¦ CID: $CID"
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
        AUTH_RESPONSE=$(curl -s -X POST https://api.filebase.io/v1/account/auth \
          -u "${{ secrets.FILEBASE_ACCESS_KEY }}:${{ secrets.FILEBASE_SECRET_KEY }}")
        TOKEN=$(echo "$AUTH_RESPONSE" | jq -r '.token')
        
        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°"
          exit 1
        fi
        
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ IPNS Ð·Ð°Ð¿Ð¸ÑÑŒ
        echo "ðŸ“¡ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑŽ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ IPNS..."
        UPDATE_RESPONSE=$(curl -s -X POST \
          "https://api.filebase.io/v1/ipns/$IPNS_KEY_NAME" \
          -H "Authorization: Bearer $TOKEN" \
          -H "Content-Type: application/json" \
          -d "{\"cid\":\"$CID\",\"name\":\"$IPNS_KEY_NAME\"}")
        
        echo "ðŸ“‹ ÐžÑ‚Ð²ÐµÑ‚ Ð¾Ñ‚ Filebase:"
        echo "$UPDATE_RESPONSE" | jq '.' 2>/dev/null || echo "$UPDATE_RESPONSE"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ÑÑ‚ÑŒ
        if echo "$UPDATE_RESPONSE" | jq -e '.record' > /dev/null 2>&1; then
          echo "âœ… IPNS Ð·Ð°Ð¿Ð¸ÑÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°!"
          echo ""
          echo "ðŸŽ‰ Ð”Ð•ÐŸÐ›ÐžÐ™ Ð—ÐÐ’Ð•Ð Ð¨Ð•Ð!"
          echo "ðŸŒ Ð’Ð°Ñˆ ÑÐ°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÐ°Ð¼:"
          echo "   â€¢ https://deathnote.rip"
          echo "   â€¢ https://ipfs.filebase.io/ipns/k51qzi5uqu5dlnkeibe66l3ccybqkyh244erdfm5nk12q6njyh8686llnusri9"
          echo "   â€¢ https://$CID.ipfs.dweb.link"
          echo ""
          echo "â±ï¸ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ DNS Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ 1-5 Ð¼Ð¸Ð½ÑƒÑ‚"
        else
          echo "âš ï¸ IPNS Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð½Ðµ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"
          echo "ðŸ“ ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ IPNS Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ‡ÐµÑ€ÐµÐ· Filebase:"
          echo "   1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ https://console.filebase.com"
          echo "   2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² IPNS Keys"
          echo "   3. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÐºÐ»ÑŽÑ‡ '$IPNS_KEY_NAME'"
          echo "   4. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Update Ð¸ Ð²ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ CID: $CID"
        fi
    
    # Ð¨Ð°Ð³ 12: Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ (ÐµÑÐ»Ð¸ CID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½)
    - name: ðŸ“ Manual update instructions
      if: env.CID_NOT_FOUND == 'true'
      run: |
        echo "âŒ CID Ð½Ðµ Ð±Ñ‹Ð» Ð½Ð°Ð¹Ð´ÐµÐ½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"
        echo ""
        echo "ðŸ“‹ Ð˜ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð˜Ð¯ Ð”Ð›Ð¯ Ð Ð£Ð§ÐÐžÐ“Ðž ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð¯:"
        echo ""
        echo "1. Ð’Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ Ð² Filebase: https://console.filebase.com"
        echo "2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ð±Ð°ÐºÐµÑ‚ 'dxn-front'"
        echo "3. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð¿Ð°Ð¿ÐºÑƒ: ${{ env.FOLDER_NAME }}"
        echo "4. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° Ð¿Ð°Ð¿ÐºÑƒ â†’ 'Copy CID'"
        echo "5. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² 'IPNS Keys'"
        echo "6. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÐºÐ»ÑŽÑ‡ 'deathnote'"
        echo "7. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Update' Ð¸ Ð²ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ CID"
        echo ""
        echo "ÐŸÐ¾ÑÐ»Ðµ ÑÑ‚Ð¾Ð³Ð¾ Ð²Ð°Ñˆ ÑÐ°Ð¹Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· 1-5 Ð¼Ð¸Ð½ÑƒÑ‚"
    
    # Ð¨Ð°Ð³ 13: ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÑÐ±Ð¾Ñ€Ð¾Ðº (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 3)
    - name: ðŸ§¹ Cleanup old deployments
      if: success() && env.CID_NOT_FOUND != 'true'
      run: |
        echo "ðŸ§¹ ÐžÑ‡Ð¸Ñ‰Ð°ÑŽ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸..."
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ð¿Ð°Ð¿Ð¾Ðº ÑÐ±Ð¾Ñ€Ð¾Ðº
        FOLDERS=$(aws s3 ls "s3://${{ env.FILEBASE_BUCKET }}/" \
          --endpoint-url "${{ env.FILEBASE_ENDPOINT }}" \
          | grep "build-" \
          | awk '{print $2}' \
          | sort -r)
        
        # Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾
        COUNT=$(echo "$FOLDERS" | wc -l)
        echo "ðŸ“Š ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ $COUNT ÑÐ±Ð¾Ñ€Ð¾Ðº"
        
        if [ $COUNT -gt 3 ]; then
          echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÑŽ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸ (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑŽ 3 Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ)..."
          TO_DELETE=$(echo "$FOLDERS" | tail -n +4)
          
          for FOLDER in $TO_DELETE; do
            echo "Ð£Ð´Ð°Ð»ÑÑŽ: $FOLDER"
            aws s3 rm "s3://${{ env.FILEBASE_BUCKET }}/$FOLDER" \
              --recursive \
              --endpoint-url "${{ env.FILEBASE_ENDPOINT }}" \
              || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ $FOLDER"
          done
          echo "âœ… ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
        else
          echo "âœ… ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ (Ð¼ÐµÐ½ÑŒÑˆÐµ 4 ÑÐ±Ð¾Ñ€Ð¾Ðº)"
        fi

    # Ð¨Ð°Ð³ 14: Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ðµ
    - name: ðŸ“Š Create deployment summary
      if: always()
      run: |
        echo "## ðŸš€ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if ${{ job.status == 'success' }}; then
          if [ "${{ env.CID_NOT_FOUND }}" = "true" ]; then
            echo "âš ï¸ **Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½, Ð½Ð¾ CID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“ ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Ð’Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ Ð² [Filebase](https://console.filebase.com)" >> $GITHUB_STEP_SUMMARY
            echo "2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ð±Ð°ÐºÐµÑ‚ **dxn-front**" >> $GITHUB_STEP_SUMMARY
            echo "3. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð¿Ð°Ð¿ÐºÑƒ **${{ env.FOLDER_NAME }}**" >> $GITHUB_STEP_SUMMARY
            echo "4. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ CID Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ IPNS ÐºÐ»ÑŽÑ‡ **deathnote**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸŒ Ð¡ÑÑ‹Ð»ÐºÐ¸ Ð½Ð° ÑÐ°Ð¹Ñ‚:**" >> $GITHUB_STEP_SUMMARY
            echo "- [deathnote.rip](https://deathnote.rip)" >> $GITHUB_STEP_SUMMARY
            echo "- [IPNS Ñ‡ÐµÑ€ÐµÐ· Filebase](https://ipfs.filebase.io/ipns/k51qzi5uqu5dlnkeibe66l3ccybqkyh244erdfm5nk12q6njyh8686llnusri9)" >> $GITHUB_STEP_SUMMARY
            echo "- [ÐŸÑ€ÑÐ¼Ð¾Ð¹ IPFS Ð´Ð¾ÑÑ‚ÑƒÐ¿](https://${{ env.IPFS_CID }}.ipfs.dweb.link)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“¦ CID Ð½Ð¾Ð²Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ env.IPFS_CID }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“ Ð˜Ð¼Ñ Ð¿Ð°Ð¿ÐºÐ¸ Ð² Filebase:** \`${{ env.FOLDER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð²Ñ‹ÑˆÐµ Ð´Ð»Ñ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Ð—Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾: $(date)*" >> $GITHUB_STEP_SUMMARY
