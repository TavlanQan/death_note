steps:
  - name: Checkout repo
    uses: actions/checkout@v4

  - name: Setup Node
    uses: actions/setup-node@v4
    with:
      node-version: 20
      cache: "npm"

  - name: Install deps
    run: npm ci

  - name: Build (Next static export)
    run: npm run build

  - name: Install IPFS CLI
    run: |
      set -euo pipefail

      # Зафиксируйте версию (��ри необходимости поменяйте)
      IPFS_VERSION=${IPFS_VERSION:-v0.30.0}

      # Определяем архитектуру runner'а
      arch=$(uname -m)
      case "$arch" in
        x86_64) ARCH="linux-amd64" ;;
        aarch64|arm64) ARCH="linux-arm64" ;;
        *) echo "Unsupported architecture: $arch"; exit 1 ;;
      esac

      FNAME="go-ipfs_${IPFS_VERSION#v}_${ARCH}.tar.gz"
      URL="https://dist.ipfs.io/go-ipfs/${IPFS_VERSION}/${FNAME}"

      echo "Downloading $URL"
      # -f чтобы падать при HTTP ошибках, -S показать ошибки, -L следовать редиректам
      curl -fSL "$URL" -o "/tmp/$FNAME"

      echo "Verifying tarball"
      # tar -tzf выйдет с ошибкой, если файл не валидный gzip tar
      tar -tzf "/tmp/$FNAME" > /dev/null

      echo "Extracting and installing ipfs"
      tar -xzf "/tmp/$FNAME" -C /tmp
      sudo mv /tmp/go-ipfs/*/ipfs /usr/local/bin/
      ipfs --version

  - name: Upload to Filebase IPFS
    id: ipfs
    env:
      FILEBASE_RPC_KEY: ${{ secrets.FILEBASE_RPC_KEY }}
    run: |
      CID=$(ipfs \
        --api="/dns4/rpc.filebase.io/tcp/443/https" \
        --api-auth="$FILEBASE_RPC_KEY" \
        add -r -Q out)
      echo "cid=$CID" >> $GITHUB_OUTPUT
      echo "Deployed CID: $CID"

  - name: Update IPNS
    env:
      FILEBASE_RPC_KEY: ${{ secrets.FILEBASE_RPC_KEY }}
      IPNS_KEY: ${{ secrets.FILEBASE_IPNS_KEY }}
    run: |
      ipfs \
        --api="/dns4/rpc.filebase.io/tcp/443/https" \
        --api-auth="$FILEBASE_RPC_KEY" \
        name publish --key=$IPNS_KEY /ipfs/${{ steps.ipfs.outputs.cid }}
