name: Deploy to IPFS via Filebase

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  FILEBASE_BUCKET: "dxn-front"
  FILEBASE_ENDPOINT: "https://s3.filebase.com"

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð´
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      - name: Install dependencies
        run: |
          npm ci
          sudo apt-get update
          sudo apt-get install -y jq
      
      # Ð¨Ð°Ð³ 4: Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
      - name: Build project
        run: npm run build
      
      # Ð¨Ð°Ð³ 5: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ
      - name: Verify build
        run: |
          echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸ out:"
          ls -la out/
          echo "Ð Ð°Ð·Ð¼ÐµÑ€ Ð¿Ð°Ð¿ÐºÐ¸:"
          du -sh out/
      
      # Ð¨Ð°Ð³ 6: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ AWS CLI
      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install --update
          aws --version
      
      # Ð¨Ð°Ð³ 7: ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ AWS CLI Ð´Ð»Ñ Filebase
      - name: Configure AWS CLI for Filebase
        run: |
          aws configure set aws_access_key_id ${{ secrets.FILEBASE_ACCESS_KEY }}
          aws configure set aws_secret_access_key ${{ secrets.FILEBASE_SECRET_KEY }}
          aws configure set default.region us-east-1
          aws configure set default.s3.max_concurrent_requests 5
          aws configure set default.s3.max_queue_size 1000
          aws configure set default.s3.multipart_threshold 64MB
          aws configure set default.s3.multipart_chunksize 16MB
          aws configure set default.s3.use_accelerate_endpoint false
          aws configure set default.s3.addressing_style virtual
      
      # Ð¨Ð°Ð³ 8: Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð¼Ñ Ð¿Ð°Ð¿ÐºÐ¸
      - name: Generate unique folder name
        id: folder-name
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          FOLDER_NAME="site-${TIMESTAMP}-${COMMIT_HASH}"
          echo "folder_name=${FOLDER_NAME}" >> $GITHUB_OUTPUT
          echo "FOLDER_NAME=${FOLDER_NAME}" >> $GITHUB_ENV
          echo "Ð˜Ð¼Ñ Ð¿Ð°Ð¿ÐºÐ¸: ${FOLDER_NAME}"
      
      # Ð¨Ð°Ð³ 9: Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð² Filebase S3
      - name: Upload to Filebase S3
        id: upload
        run: |
          FOLDER_NAME="${{ steps.folder-name.outputs.folder_name }}"
          S3_PATH="s3://${{ env.FILEBASE_BUCKET }}/${FOLDER_NAME}/"
          
          echo "Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽ Ð²: ${S3_PATH}"
          
          # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ out
          aws s3 sync ./out/ "${S3_PATH}" \
            --endpoint-url "${{ env.FILEBASE_ENDPOINT }}" \
            --acl public-read
          
          echo "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
          echo "S3_PATH=${S3_PATH}" >> $GITHUB_ENV
      
      # Ð¨Ð°Ð³ 10: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ CID Ñ‡ÐµÑ€ÐµÐ· Filebase API
      - name: Get CID from Filebase
        id: get-cid
        run: |
          echo "ÐŸÑ€Ð¾Ð±ÑƒÑŽ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ CID..."
          
          FOLDER_NAME="${{ steps.folder-name.outputs.folder_name }}"
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
          echo "Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÑŽ Ñ‚Ð¾ÐºÐµÐ½..."
          AUTH_RESPONSE=$(curl -s -X POST "https://api.filebase.io/v1/account/auth" \
            -u "${{ secrets.FILEBASE_ACCESS_KEY }}:${{ secrets.FILEBASE_SECRET_KEY }}")
          
          echo "ÐžÑ‚Ð²ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸:"
          echo "$AUTH_RESPONSE"
          
          # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ñ‚Ð¾ÐºÐµÐ½
          TOKEN=$(echo "$AUTH_RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4 || true)
          
          if [ -z "$TOKEN" ] && command -v jq > /dev/null; then
            TOKEN=$(echo "$AUTH_RESPONSE" | jq -r '.token' 2>/dev/null || true)
          fi
          
          if [ -z "$TOKEN" ]; then
            echo "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾ÐºÐµÐ½"
            echo "cid=not_found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Ð¢Ð¾ÐºÐµÐ½ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½"
          
          # Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾
          sleep 5
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð²
          echo "Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÑŽ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð²..."
          LIST_RESPONSE=$(curl -s -X GET \
            "https://api.filebase.io/v1/ipfs/buckets/${{ env.FILEBASE_BUCKET }}/keys" \
            -H "Authorization: Bearer $TOKEN")
          
          echo "ÐžÑ‚Ð²ÐµÑ‚ ÑÐ¿Ð¸ÑÐºÐ° Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð² (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 500 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²):"
          echo "${LIST_RESPONSE:0:500}"
          
          # Ð˜Ñ‰ÐµÐ¼ CID
          CID=""
          
          # ÐœÐµÑ‚Ð¾Ð´ 1: Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸ Ð¿Ð°Ð¿ÐºÐ¸
          if [ -n "$LIST_RESPONSE" ]; then
            CID=$(echo "$LIST_RESPONSE" | grep -o "\"name\":\"${FOLDER_NAME}[^\"]*\".*\"cid\":\"[^\"]*\"" | head -1 | grep -o '"cid":"[^"]*"' | cut -d'"' -f4 || true)
          fi
          
          # ÐœÐµÑ‚Ð¾Ð´ 2: Ð˜Ñ‰ÐµÐ¼ Ð»ÑŽÐ±Ð¾Ð¹ CID
          if [ -z "$CID" ]; then
            CID=$(echo "$LIST_RESPONSE" | grep -o '"cid":"[^"]*"' | head -1 | cut -d'"' -f4 || true)
          fi
          
          # ÐœÐµÑ‚Ð¾Ð´ 3: Ð˜Ñ‰ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· Ñ€ÐµÐ³ÑƒÐ»ÑÑ€ÐºÑƒ
          if [ -z "$CID" ]; then
            CID=$(echo "$LIST_RESPONSE" | grep -o 'Qm[1-9A-HJ-NP-Za-km-z]\{44,\}' | head -1 || true)
          fi
          
          if [ -n "$CID" ]; then
            echo "CID Ð½Ð°Ð¹Ð´ÐµÐ½: $CID"
            echo "cid=$CID" >> $GITHUB_OUTPUT
            echo "IPFS_CID=$CID" >> $GITHUB_ENV
          else
            echo "CID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"
            echo "cid=not_found" >> $GITHUB_OUTPUT
          fi
      
      # Ð¨Ð°Ð³ 11: ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
      - name: Show deployment result
        run: |
          echo "========================================"
          echo "ðŸš€ Ð”Ð•ÐŸÐ›ÐžÐ™ Ð’Ð«ÐŸÐžÐ›ÐÐ•Ð!"
          echo "========================================"
          echo ""
          echo "ðŸ“ ÐŸÐ°Ð¿ÐºÐ° Ð² Filebase: ${{ steps.folder-name.outputs.folder_name }}"
          echo ""
          
          if [ "${{ steps.get-cid.outputs.cid }}" != "not_found" ]; then
            echo "ðŸ“¦ CID: ${{ steps.get-cid.outputs.cid }}"
            echo ""
            echo "ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ¸:"
            echo "- https://deathnote.rip"
            echo "- https://ipfs.filebase.io/ipns/k51qzi5uqu5dlnkeibe66l3ccybqkyh244erdfm5nk12q6njyh8686llnusri9"
            echo "- https://${{ steps.get-cid.outputs.cid }}.ipfs.dweb.link"
            echo ""
            echo "ðŸ“ Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ°Ð¹Ñ‚:"
            echo "1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ https://console.filebase.com"
            echo "2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² 'IPNS Keys'"
            echo "3. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÐºÐ»ÑŽÑ‡ 'deathnote'"
            echo "4. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Update'"
            echo "5. Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ CID: ${{ steps.get-cid.outputs.cid }}"
            echo "6. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Update Record'"
          else
            echo "âŒ CID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"
            echo ""
            echo "ðŸ“ Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ CID Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ°Ð¹Ñ‚:"
            echo "1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ https://console.filebase.com"
            echo "2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ð±Ð°ÐºÐµÑ‚ 'dxn-front'"
            echo "3. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð¿Ð°Ð¿ÐºÑƒ '${{ steps.folder-name.outputs.folder_name }}'"
            echo "4. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° Ð¿Ð°Ð¿ÐºÑƒ â†’ Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ CID"
            echo "5. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² 'IPNS Keys'"
            echo "6. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÐºÐ»ÑŽÑ‡ 'deathnote'"
            echo "7. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Update' â†’ Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ CID â†’ 'Update Record'"
          fi
          echo ""
          echo "â±ï¸ ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ IPNS ÑÐ°Ð¹Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· 1-5 Ð¼Ð¸Ð½ÑƒÑ‚"
          echo "========================================"
      
      # Ð¨Ð°Ð³ 12: Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð² GitHub
      - name: Create deployment summary
        run: |
          echo "## Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.get-cid.outputs.cid }}" != "not_found" ]; then
            echo "âœ… **Ð¤Ð°Ð¹Ð»Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð² Filebase**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“ ÐŸÐ°Ð¿ÐºÐ°:** \`${{ steps.folder-name.outputs.folder_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“¦ CID:** \`${{ steps.get-cid.outputs.cid }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“ Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Ð’Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ Ð² [Filebase](https://console.filebase.com)" >> $GITHUB_STEP_SUMMARY
            echo "2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² **IPNS Keys**" >> $GITHUB_STEP_SUMMARY
            echo "3. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÐºÐ»ÑŽÑ‡ **deathnote**" >> $GITHUB_STEP_SUMMARY
            echo "4. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ **Update** Ð¸ Ð²ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ CID Ð²Ñ‹ÑˆÐµ" >> $GITHUB_STEP_SUMMARY
            echo "5. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ **Update Record**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Ð¤Ð°Ð¹Ð»Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹, Ð½Ð¾ CID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“ ÐŸÐ°Ð¿ÐºÐ°:** \`${{ steps.folder-name.outputs.folder_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“ Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Ð’Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ Ð² [Filebase](https://console.filebase.com)" >> $GITHUB_STEP_SUMMARY
            echo "2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ð±Ð°ÐºÐµÑ‚ **dxn-front**" >> $GITHUB_STEP_SUMMARY
            echo "3. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð¿Ð°Ð¿ÐºÑƒ **${{ steps.folder-name.outputs.folder_name }}**" >> $GITHUB_STEP_SUMMARY
            echo "4. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ CID Ð¸Ð· Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð¿Ð°Ð¿ÐºÐµ" >> $GITHUB_STEP_SUMMARY
            echo "5. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² **IPNS Keys** â†’ ÐºÐ»ÑŽÑ‡ **deathnote**" >> $GITHUB_STEP_SUMMARY
            echo "6. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ CID Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ IPNS ÑÐ°Ð¹Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ [deathnote.rip](https://deathnote.rip)" >> $GITHUB_STEP_SUMMARY
