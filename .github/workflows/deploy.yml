name: ðŸš€ Deploy to Deathnote Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸšš ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð´
      uses: actions/checkout@v3
    
    - name: ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      run: npm ci
    
    - name: ðŸ—ï¸ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
      run: npm run build
      env:
        NODE_ENV: production
    
    - name: ðŸ› ï¸ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        echo "SSH ÐºÐ»ÑŽÑ‡ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
    
    - name: ðŸ“¤ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ð¸Ð¼
      run: |
        ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          cd /var/www/deathnote/death_note
          git pull origin main
          npm install --production
          npm run build
          chown -R root:www-data /var/www/deathnote/death_note
          chmod -R 775 /var/www/deathnote/death_note
          echo 'âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¸Ð· GitHub Actions Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½: $(date)' >> /var/log/deploy.log
        "
    
    - name: âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾
      run: echo "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
