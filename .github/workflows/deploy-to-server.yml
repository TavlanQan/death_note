name: ðŸš€ Deploy to Deathnote Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸšš ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð´
      uses: actions/checkout@v3
    
    - name: ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      run: npm ci
    
    - name: ðŸ—ï¸ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
      run: npm run build
      env:
        NODE_ENV: production
    
    - name: ðŸ“¤ Ð”ÐµÐ¿Ð»Ð¾Ð¸Ð¼ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          cd /var/www/deathnote/death_note
          git pull origin main
          npm install --production
          npm run build
          chown -R root:www-data /var/www/deathnote/death_note
          chmod -R 775 /var/www/deathnote/death_note
          echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¸Ð· GitHub Actions Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½: $(date)" >> /var/log/deploy.log
    
    - name: âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾
      run: echo "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
